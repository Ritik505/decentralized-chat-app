===========decentralized chat=================









<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-Chat | Decentralized Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    
    <style>
:root {
    --color-bg-primary: #0D1117;
    --color-bg-secondary: #161B22;
    --color-bg-card: #21262D;
    --color-border: #30363D;
    --color-accent-primary: #58A6FF;
    --color-accent-dark: #377FEA;
    --color-text-light: #C9D1D9;
    --color-text-muted: #8B949E;
}

.light {
    --color-bg-primary: #F6F8FA;
    --color-bg-secondary: #FFFFFF;
    --color-bg-card: #FFFFFF;
    --color-border: #E6E8EB;
    --color-accent-primary: #2563EB;
    --color-accent-dark: #1D4ED8;
    --color-text-light: #0F172A;
    --color-text-muted: #475569;
}

html, body {
    height: 100%;
    margin: 0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: var(--color-bg-primary) !important;
    color: var(--color-text-light) !important;
    box-sizing: border-box;
    overflow: hidden;
}

*, *::before, *::after { box-sizing: inherit; }

#auth-page { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; }
#auth-page > div {
    background-color: var(--color-bg-card) !important;
    border-radius: 12px !important;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    border: 1px solid var(--color-border);
}

#auth-page h1 { color: #FFFFFF !important; font-size: 1.875rem !important; }

.flex.border-b { border-bottom: 2px solid var(--color-border) !important; }
.flex.border-b button { 
    color: var(--color-text-muted) !important; 
    border-bottom: 2px solid transparent !important; 
    transition: all 0.2s ease;
}

#tab-login.active, #tab-signup.active { 
    color: var(--color-text-light) !important;
    border-bottom-color: var(--color-accent-primary) !important;
}

#auth-forms input, #new-chat-username, #message-input {
    background-color: var(--color-bg-secondary) !important;
    border: 1px solid var(--color-border) !important;
    color: var(--color-text-light) !important;
    transition: border-color 0.2s, box-shadow 0.2s;
}

#auth-forms input:focus, #new-chat-username:focus, #message-input:focus {
    border-color: var(--color-accent-primary) !important;
    box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3) !important;
    outline: none !important;
}

button[type="submit"], #new-chat-button {
    background-color: var(--color-accent-primary) !important;
    color: #FFFFFF !important;
    transition: background-color 0.2s;
}

button[type="submit"]:hover, #new-chat-button:hover {
    background-color: var(--color-accent-dark) !important;
}

button[type="submit"]:disabled, #new-chat-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#cancel-new-chat { 
    background-color: var(--color-bg-card) !important;
    color: var(--color-text-light) !important;
    border: 1px solid var(--color-border) !important;
}

#cancel-new-chat:hover {
    background-color: var(--color-border) !important;
}

#chat-page > div.flex { display: flex; height: 100%; }
.flex-col.w-full {
    background-color: var(--color-bg-secondary) !important;
    border-right: 1px solid var(--color-border) !important;
}

.flex-shrink-0.h-16 {
    background-color: var(--color-bg-secondary) !important;
    border-bottom: 1px solid var(--color-border) !important;
}

#user-avatar, #chat-partner-avatar {
    background-color: var(--color-accent-dark) !important;
    width: 36px !important; 
    height: 36px !important;
}

#logout-button { color: var(--color-text-muted) !important; }
#logout-button:hover { color: var(--color-text-light) !important; }

#contacts-list { overflow-y: auto; }

.contact-item { 
    display: flex; align-items: center; padding: 1rem; cursor: pointer; 
    border-bottom: 1px solid var(--color-border); 
    transition: background-color 0.15s ease;
}

.contact-item:hover { background-color: var(--color-bg-card) !important; }
.contact-item.active {
    background-color: var(--color-bg-card) !important;
    border-left: 3px solid var(--color-accent-primary);
    margin-left: -3px;
}

.contact-item p { color: var(--color-text-light) !important; }
.contact-item p.text-sm { color: var(--color-text-muted) !important; }

.flex-1.flex.flex-col { background-color: var(--color-bg-primary) !important; }
#chat-welcome { color: var(--color-text-muted) !important; }
#chat-welcome h2 { color: var(--color-text-light) !important; }

#message-form {
    background-color: var(--color-bg-secondary) !important;
    border-top: 1px solid var(--color-border) !important;
}

#chat-messages { overflow-y: auto; }

.message-bubble { 
    max-width: 65%;
    padding: 0.75rem 1rem; 
    border-radius: 18px; 
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.15); 
    word-wrap: break-word;
    line-height: 1.4;
}

.message-bubble.sent {
    background-color: var(--color-accent-primary) !important;
    color: #FFFFFF !important;
    margin-left: auto;
    border-bottom-right-radius: 8px;
}

.message-bubble.received {
    background-color: var(--color-bg-card) !important;
    color: var(--color-text-light) !important;
    margin-right: auto;
    border-bottom-left-radius: 8px;
}

.message-time { 
    color: rgba(201, 209, 217, 0.5);
    font-size: 0.7rem; 
    margin: 0 8px;
}

#chat-messages::-webkit-scrollbar,
#contacts-list::-webkit-scrollbar { width: 8px; height: 8px; }

#chat-messages::-webkit-scrollbar-track,
#contacts-list::-webkit-scrollbar-track { background: var(--color-bg-secondary); }

#chat-messages::-webkit-scrollbar-thumb,
#contacts-list::-webkit-scrollbar-thumb { 
    background: var(--color-border);
    border-radius: 4px; 
}

.hidden { display: none !important; }

.emoji-button {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 20px;
    width: 40px;
    height: 40px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-light);
}

#emoji-picker {
    position: absolute;
    bottom: 72px;
    right: 24px;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    padding: 8px;
    border-radius: 8px;
    display: none;
    width: 260px;
    max-width: calc(100% - 48px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    z-index: 60;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 6px;
    max-height: 220px;
    overflow: auto;
}

.emoji-cell {
    font-size: 1.25rem;
    padding: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    background: none;
    border: none;
}

.emoji-cell:hover {
    background: var(--color-bg-secondary);
}

.status-message {
    padding: 12px;
    border-radius: 8px;
    margin: 8px 0;
    font-size: 14px;
}

.status-error {
    background-color: rgba(239, 68, 68, 0.2) !important;
    color: #FCA5A5 !important;
    border: 1px solid rgba(239, 68, 68, 0.5);
}

.status-success {
    background-color: rgba(34, 197, 94, 0.2) !important;
    color: #86EFAC !important;
    border: 1px solid rgba(34, 197, 94, 0.5);
}

.status-info {
    background-color: rgba(59, 130, 246, 0.2) !important;
    color: #93C5FD !important;
    border: 1px solid rgba(59, 130, 246, 0.5);
}

@media (max-width: 768px) {
    .flex-col.w-full { width: 100% !important; }
    .message-bubble { max-width: 85%; }
}
    </style>
</head>
<body class="h-full font-sans text-gray-200 antialiased">

    <div id="app-container" class="h-full">
        <!-- Auth Page -->
        <div id="auth-page" class="flex items-center justify-center h-full p-4">
            <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-lg p-8">
                <h1 class="text-3xl font-bold text-center text-white mb-2">D-Chat</h1>
                <p class="text-center text-gray-400 mb-6">Decentralized & Encrypted</p>

                <div class="flex border-b border-gray-700 mb-6">
                    <button id="tab-login" class="flex-1 py-2 font-semibold active transition-colors duration-200">Login</button>
                    <button id="tab-signup" class="flex-1 py-2 font-semibold transition-colors duration-200">Sign Up</button>
                </div>

                <div id="auth-forms">
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-username" class="block text-sm font-medium text-gray-300">Username</label>
                            <input type="text" id="login-username" required autocomplete="username" class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="login-password" required autocomplete="current-password" class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button type="submit" id="login-submit" class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-semibold transition duration-200">Login</button>
                    </form>

                    <form id="signup-form" class="space-y-4 hidden">
                        <div>
                            <label for="signup-username" class="block text-sm font-medium text-gray-300">Username</label>
                            <input type="text" id="signup-username" required autocomplete="username" minlength="3" maxlength="32" class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-400 mt-1">3-32 characters, alphanumeric and underscore only</p>
                        </div>
                        <div>
                            <label for="signup-password" class="block text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="signup-password" required autocomplete="new-password" minlength="8" class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-400 mt-1">Minimum 8 characters</p>
                        </div>
                        <button type="submit" id="signup-submit" class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-semibold transition duration-200">Sign Up</button>
                    </form>
                </div>

                <div id="auth-status" class="mt-4"></div>
            </div>
        </div>

        <!-- Chat Page -->
        <div id="chat-page" class="hidden h-full">
            <div class="flex h-full">
                <div class="flex flex-col w-full md:w-1/3 lg:w-1/4 h-full bg-gray-800 border-r border-gray-700">
                    <div class="flex items-center justify-between p-4 border-b border-gray-700 h-16 flex-shrink-0">
                        <div class="flex items-center space-x-2 min-w-0">
                            <div id="user-avatar" class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white flex-shrink-0"></div>
                            <span id="current-username" class="font-semibold text-white truncate"></span>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <button id="theme-toggle" class="text-gray-400 hover:text-white p-2">
                                <svg id="theme-icon" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-11.34l-.7.7M4.04 19.96l-.7-.7M21 12h-1M4 12H3m15.66 5.66l-.7-.7M4.04 4.04l-.7.7"></path>
                                </svg>
                            </button>
                            <button id="logout-button" class="text-gray-400 hover:text-white p-2">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            </button>
                        </div>
                    </div>

                    <div class="p-4">
                        <button id="new-chat-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span>New Chat</span>
                        </button>
                    </div>

                    <div id="contacts-list" class="flex-1 overflow-y-auto">
                        <p id="no-contacts" class="text-gray-500 text-center p-4">No recent chats.</p>
                    </div>
                </div>

                <div class="flex-1 flex flex-col h-full">
                    <div id="chat-header" class="flex items-center p-4 border-b border-gray-700 h-16 flex-shrink-0 bg-gray-800 hidden">
                        <div id="chat-partner-avatar" class="w-8 h-8 rounded-full bg-gray-500 flex items-center justify-center font-bold text-white flex-shrink-0"></div>
                        <span id="chat-partner-username" class="ml-3 font-semibold text-white truncate"></span>
                    </div>

                    <div id="chat-welcome" class="flex-1 flex flex-col items-center justify-center text-gray-500 p-8 text-center">
                        <svg class="w-24 h-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2s10 4.477 10 10z"></path></svg>
                        <h2 class="text-2xl font-semibold text-gray-400">Welcome to D-Chat</h2>
                        <p>Select a chat on the left or start a new one.</p>
                        <p class="text-sm mt-2">All messages are end-to-end encrypted.</p>
                    </div>
                    
                    <div id="chat-messages-container" class="hidden flex-1 flex flex-col">
                        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4"></div>

                        <form id="message-form" class="p-4 border-t border-gray-700 bg-gray-800 relative">
                            <div class="flex items-center space-x-3">
                                <button type="button" id="emoji-button" class="emoji-button">ðŸ˜Š</button>
                                <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <button type="submit" id="send-button" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg p-3 transition duration-200">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                            </div>
                            <div id="emoji-picker" aria-hidden="true">
                                <div class="emoji-grid" id="emoji-grid"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Chat Modal -->
        <div id="new-chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-md">
                <h2 class="text-2xl font-bold text-white mb-6">Start a New Chat</h2>
                <form id="new-chat-form">
                    <div class="space-y-4">
                        <div>
                            <label for="new-chat-username" class="block text-sm font-medium text-gray-300">Username</label>
                            <input type="text" id="new-chat-username" required autocomplete="off" class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <p id="new-chat-status" class="text-sm"></p>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="cancel-new-chat" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-semibold transition duration-200">Cancel</button>
                            <button type="submit" id="new-chat-submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-semibold transition duration-200">Start Chat</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize Gun
        const gun = Gun({
            peers: [
                'https://gun.db20.com/gun',
                'https://gunjs.herokuapp.com/gun',
                'https://gun-server-gun.herokuapp.com/gun',
                'https://api.gundb.io/gun'
            ]
        });

        const app = {
            currentUser: null,
            currentChat: null,
            sharedKeys: {},
            userKeys: null,
            listeners: {},
            messageCache: {},
            isOnline: navigator.onLine
        };

        window.addEventListener('online', () => { app.isOnline = true; });
        window.addEventListener('offline', () => { app.isOnline = false; });

        // DOM Elements
        const authPage = document.getElementById('auth-page');
        const chatPage = document.getElementById('chat-page');
        const authStatus = document.getElementById('auth-status');
        const tabLogin = document.getElementById('tab-login');
        const tabSignup = document.getElementById('tab-signup');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginSubmit = document.getElementById('login-submit');
        const signupSubmit = document.getElementById('signup-submit');
        const currentUsernameEl = document.getElementById('current-username');
        const userAvatarEl = document.getElementById('user-avatar');
        const logoutButton = document.getElementById('logout-button');
        const newChatButton = document.getElementById('new-chat-button');
        const newChatModal = document.getElementById('new-chat-modal');
        const newChatForm = document.getElementById('new-chat-form');
        const newChatStatus = document.getElementById('new-chat-status');
        const newChatSubmit = document.getElementById('new-chat-submit');
        const cancelNewChat = document.getElementById('cancel-new-chat');
        const contactsList = document.getElementById('contacts-list');
        const noContactsEl = document.getElementById('no-contacts');
        const chatWelcome = document.getElementById('chat-welcome');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const chatHeader = document.getElementById('chat-header');
        const chatPartnerAvatar = document.getElementById('chat-partner-avatar');
        const chatPartnerUsername = document.getElementById('chat-partner-username');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPicker = document.getElementById('emoji-picker');
        const emojiGrid = document.getElementById('emoji-grid');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        const EMOJIS = ['ðŸ˜€','ðŸ˜','ðŸ˜‚','ðŸ¤£','ðŸ™‚','ðŸ™ƒ','ðŸ˜‰','ðŸ˜','ðŸ˜˜','ðŸ˜…','ðŸ¤”','ðŸ¤ž','ðŸ‘','ðŸ‘Ž','ðŸ™','ðŸŽ‰','ðŸ”¥','ðŸŒŸ','ðŸ’¯','â¤ï¸','ðŸ˜Ž','ðŸ¤—','ðŸ˜´','ðŸ¤–','ðŸ˜‡','ðŸ˜¬','ðŸ˜œ','ðŸ˜¢','ðŸ˜­','ðŸ˜¡','ðŸ¥³'];

        // Utilities
        function showStatus(message, type = 'info') {
            authStatus.innerHTML = '';
            if (!message) return;
            const div = document.createElement('div');
            div.className = `status-message status-${type}`;
            div.textContent = message;
            authStatus.appendChild(div);
        }

        function validateUsername(username) {
            return /^[a-zA-Z0-9_]{3,32}$/.test(username);
        }

        function validatePassword(password) {
            return password.length >= 8;
        }

        function populateEmojis() {
            emojiGrid.innerHTML = '';
            EMOJIS.forEach(e => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'emoji-cell';
                btn.textContent = e;
                btn.addEventListener('click', (evt) => {
                    evt.preventDefault();
                    const start = messageInput.selectionStart || 0;
                    const end = messageInput.selectionEnd || 0;
                    const value = messageInput.value || '';
                    messageInput.value = value.slice(0, start) + e + value.slice(end);
                    const pos = start + e.length;
                    messageInput.setSelectionRange(pos, pos);
                    emojiPicker.style.display = 'none';
                    messageInput.focus();
                });
                emojiGrid.appendChild(btn);
            });
        }

        emojiButton?.addEventListener('click', (e) => {
            e.preventDefault();
            populateEmojis();
            emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && !emojiButton.contains(e.target)) {
                emojiPicker.style.display = 'none';
            }
        });

        // Crypto
        function arrayBufferToB64(buffer) {
            const bytes = buffer instanceof Uint8Array ? buffer : new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function b64ToArrayBuffer(b64) {
            const binary = window.atob(b64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function textToArrayBuffer(str) {
            return new TextEncoder().encode(str);
        }

        function arrayBufferToText(buffer) {
            return new TextDecoder().decode(buffer);
        }

        async function generateKeys() {
            return await crypto.subtle.generateKey(
                { name: 'ECDH', namedCurve: 'P-256' },
                true,
                ['deriveKey']
            );
        }

        async function importPubKey(jwk) {
            if (typeof jwk === 'string') jwk = JSON.parse(jwk);
            return await crypto.subtle.importKey('jwk', jwk, { name: 'ECDH', namedCurve: 'P-256' }, true, []);
        }

        async function importPrivKey(jwk) {
            if (typeof jwk === 'string') jwk = JSON.parse(jwk);
            return await crypto.subtle.importKey('jwk', jwk, { name: 'ECDH', namedCurve: 'P-256' }, true, ['deriveKey']);
        }

        async function deriveSharedKey(myPrivateKey, partnerPublicKey) {
            return await crypto.subtle.deriveKey(
                { name: 'ECDH', public: partnerPublicKey },
                myPrivateKey,
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        }

        async function encryptMessage(sharedKey, plaintext) {
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encodedText = textToArrayBuffer(plaintext);
            const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, sharedKey, encodedText);
            return { ct: arrayBufferToB64(ciphertext), iv: arrayBufferToB64(iv) };
        }

        async function decryptMessage(sharedKey, ct_b64, iv_b64) {
            try {
                const ciphertext = b64ToArrayBuffer(ct_b64);
                const iv = new Uint8Array(b64ToArrayBuffer(iv_b64));
                const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, sharedKey, ciphertext);
                return arrayBufferToText(decrypted);
            } catch (e) {
                console.error("Decryption error:", e);
                return "ðŸ”’ Unable to decrypt";
            }
        }

        // Auth
        function switchTab(tab) {
            const isLogin = tab === 'login';
            loginForm.classList.toggle('hidden', !isLogin);
            signupForm.classList.toggle('hidden', isLogin);
            tabLogin.classList.toggle('active', isLogin);
            tabSignup.classList.toggle('active', !isLogin);
            showStatus('');
        }

        async function handleSignup(e) {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim().toLowerCase();
            const password = document.getElementById('signup-password').value;

            if (!validateUsername(username)) {
                showStatus('Username must be 3-32 characters, alphanumeric + underscore only.', 'error');
                return;
            }
            if (!validatePassword(password)) {
                showStatus('Password must be at least 8 characters.', 'error');
                return;
            }

            signupSubmit.disabled = true;
            showStatus('Checking username...', 'info');

            try {
                const userExists = await fetchUserData(username);
                if (userExists) {
                    showStatus('Username already taken.', 'error');
                    signupSubmit.disabled = false;
                    return;
                }

                showStatus('Generating keys...', 'info');
                const keyPair = await generateKeys();
                const pubKeyJwk = await crypto.subtle.exportKey('jwk', keyPair.publicKey);
                const privKeyJwk = await crypto.subtle.exportKey('jwk', keyPair.privateKey);

                const encryptedPrivKey = CryptoJS.AES.encrypt(JSON.stringify(privKeyJwk), password).toString();

                showStatus('Creating account...', 'info');
                const userNode = gun.get('users').get(username);
                userNode.put({ pubKey: JSON.stringify(pubKeyJwk), privKey: encryptedPrivKey, createdAt: Date.now() });
                userNode.get('chats').put({});

                await new Promise(resolve => setTimeout(resolve, 2000));

                showStatus('âœ… Signup successful!', 'success');
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                signupForm.reset();
                document.getElementById('login-username').value = username;
                switchTab('login');
                document.getElementById('login-password').focus();
                signupSubmit.disabled = false;
                showStatus('');

            } catch (err) {
                console.error('Signup error:', err);
                showStatus('Signup failed', 'error');
                signupSubmit.disabled = false;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                showStatus('Username and password required.', 'error');
                return;
            }

            loginSubmit.disabled = true;
            showStatus('Logging in...', 'info');

            try {
                const userData = await new Promise((resolve) => {
                    const timeout = setTimeout(() => resolve(null), 8000);
                    gun.get('users').get(username).once(data => {
                        clearTimeout(timeout);
                        resolve(data);
                    });
                });

                if (!userData || !userData.privKey) {
                    showStatus('Invalid username or password.', 'error');
                    loginSubmit.disabled = false;
                    return;
                }

                const decryptedStr = CryptoJS.AES.decrypt(userData.privKey, password).toString(CryptoJS.enc.Utf8);
                
                if (!decryptedStr) {
                    showStatus('Invalid username or password.', 'error');
                    loginSubmit.disabled = false;
                    return;
                }

                const privKeyJwk = JSON.parse(decryptedStr);
                const pubKeyJwk = typeof userData.pubKey === 'string' ? JSON.parse(userData.pubKey) : userData.pubKey;

                showStatus('Importing keys...', 'info');
                app.userKeys = {
                    privateKey: await importPrivKey(privKeyJwk),
                    publicKey: await importPubKey(pubKeyJwk)
                };

                app.currentUser = username;
                sessionStorage.setItem('currentUser', username);
                sessionStorage.setItem('privKey', JSON.stringify(privKeyJwk));
                sessionStorage.setItem('pubKey', JSON.stringify(pubKeyJwk));

                loginForm.reset();
                showStatus('');
                await initChatPage();
                loginSubmit.disabled = false;

            } catch (err) {
                console.error('Login error:', err);
                showStatus('Login failed.', 'error');
                loginSubmit.disabled = false;
            }
        }

        function handleLogout() {
            Object.values(app.listeners).forEach(off => {
                try { if (typeof off === 'function') off(); } catch (e) {}
            });
            app.listeners = {};
            sessionStorage.clear();
            app.currentUser = null;
            app.userKeys = null;
            app.currentChat = null;
            app.sharedKeys = {};
            app.messageCache = {};

            contactsList.innerHTML = '';
            chatMessages.innerHTML = '';
            noContactsEl.classList.remove('hidden');
            chatPage.classList.add('hidden');
            authPage.classList.remove('hidden');
            switchTab('login');
        }

        // Chat
        async function initChatPage() {
            authPage.classList.add('hidden');
            chatPage.classList.remove('hidden');
            currentUsernameEl.textContent = app.currentUser;
            userAvatarEl.textContent = app.currentUser.charAt(0).toUpperCase();
            loadUserChats();
        }

        function loadUserChats() {
            if (app.listeners.chatsLoader) app.listeners.chatsLoader();
            contactsList.innerHTML = '';
            noContactsEl.classList.remove('hidden');

            const offFunc = gun.get('users').get(app.currentUser).get('chats').map().on((val, key) => {
                if (!val || key === '_') return;
                if (key !== app.currentUser) {
                    addContactToList(key);
                }
            });

            app.listeners.chatsLoader = offFunc;
        }

        async function handleNewChat(e) {
            e.preventDefault();
            const username = document.getElementById('new-chat-username').value.trim().toLowerCase();
            newChatStatus.textContent = '';

            if (!username) {
                newChatStatus.textContent = 'Enter a username.';
                newChatStatus.className = 'text-sm status-error';
                return;
            }

            if (username === app.currentUser) {
                newChatStatus.textContent = "Can't chat with yourself.";
                newChatStatus.className = 'text-sm status-error';
                return;
            }

            newChatSubmit.disabled = true;
            newChatStatus.textContent = 'Searching user...';
            newChatStatus.className = 'text-sm status-info';

            try {
                let userData = null;
                for (let attempt = 1; attempt <= 4; attempt++) {
                    newChatStatus.textContent = `Searching (${attempt}/4)...`;
                    userData = await fetchUserData(username);
                    if (userData) break;
                    if (attempt < 4) await new Promise(resolve => setTimeout(resolve, 800));
                }

                if (!userData) {
                    newChatStatus.textContent = 'User not found.';
                    newChatStatus.className = 'text-sm status-error';
                    newChatSubmit.disabled = false;
                    return;
                }

                gun.get('users').get(app.currentUser).get('chats').get(username).put({ createdAt: Date.now() });
                gun.get('users').get(username).get('chats').get(app.currentUser).put({ createdAt: Date.now() });

                await new Promise(resolve => setTimeout(resolve, 1000));

                addContactToList(username);
                newChatModal.classList.add('hidden');
                newChatForm.reset();
                newChatStatus.textContent = '';
                newChatSubmit.disabled = false;

                openChat(username);

            } catch (err) {
                console.error('New chat error:', err);
                newChatStatus.textContent = 'Search failed.';
                newChatStatus.className = 'text-sm status-error';
                newChatSubmit.disabled = false;
            }
        }

        function fetchUserData(username) {
            return new Promise((resolve) => {
                let found = false;
                const timeout = setTimeout(() => {
                    if (!found) {
                        found = true;
                        resolve(null);
                    }
                }, 3000);

                gun.get('users').get(username).once((userData) => {
                    if (found) return;
                    if (userData && userData.pubKey) {
                        found = true;
                        clearTimeout(timeout);
                        resolve({ pubKey: userData.pubKey });
                    }
                });
            });
        }

        function addContactToList(username) {
            noContactsEl.classList.add('hidden');
            if (document.getElementById(`contact-${username}`)) return;

            const contactEl = document.createElement('div');
            contactEl.id = `contact-${username}`;
            contactEl.className = 'contact-item';
            contactEl.innerHTML = `
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white flex-shrink-0" style="background-color: hsl(${username.charCodeAt(0) * 10}, 70%, 50%)">
                    ${username.charAt(0).toUpperCase()}
                </div>
                <div class="ml-3 flex-1 min-w-0">
                    <p class="font-semibold truncate">${username}</p>
                    <p class="text-sm truncate">Tap to open</p>
                </div>
            `;

            contactEl.addEventListener('click', () => openChat(username));
            contactsList.prepend(contactEl);
        }

        async function openChat(partnerUsername) {
            try {
                const pubKeyData = await new Promise((resolve) => {
                    const timeout = setTimeout(() => resolve(null), 6000);
                    gun.get('users').get(partnerUsername).get('pubKey').once(data => {
                        clearTimeout(timeout);
                        resolve(data);
                    });
                });

                if (!pubKeyData) throw new Error('Could not fetch keys');

                const pubKeyJwk = typeof pubKeyData === 'string' ? JSON.parse(pubKeyData) : pubKeyData;
                const partnerPubKey = await importPubKey(pubKeyJwk);
                const sharedKey = await deriveSharedKey(app.userKeys.privateKey, partnerPubKey);
                app.sharedKeys[partnerUsername] = sharedKey;

                if (app.listeners.messagesLoader) app.listeners.messagesLoader();

                app.currentChat = {
                    partner: partnerUsername,
                    id: `${[app.currentUser, partnerUsername].sort().join(':')}`
                };

                chatWelcome.classList.add('hidden');
                chatMessagesContainer.classList.remove('hidden');
                chatHeader.classList.remove('hidden');

                chatPartnerUsername.textContent = partnerUsername;
                chatPartnerAvatar.textContent = partnerUsername.charAt(0).toUpperCase();
                chatMessages.innerHTML = '';
                app.messageCache = {};

                document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
                document.getElementById(`contact-${partnerUsername}`)?.classList.add('active');

                const offFunc = gun.get('chats').get(app.currentChat.id).map().on((msg, msgKey) => {
                    if (!msg || !msg.sender || msgKey === '_') return;
                    if (!app.messageCache[msgKey]) {
                        app.messageCache[msgKey] = true;
                        displayMessage(msg);
                    }
                });

                app.listeners.messagesLoader = offFunc;

            } catch (err) {
                console.error('Chat open error:', err);
                alert('Error opening chat');
            }
        }

        async function displayMessage(msg) {
            const isMe = msg.sender === app.currentUser;
            let plaintext = '...';

            if (isMe && msg.text) {
                plaintext = msg.text;
            } else if (!isMe && msg.ct && msg.iv) {
                try {
                    const sharedKey = app.sharedKeys[msg.sender];
                    plaintext = await decryptMessage(sharedKey, msg.ct, msg.iv);
                } catch (e) {
                    plaintext = 'ðŸ”’ Decrypt failed';
                }
            }

            const msgEl = document.createElement('div');
            msgEl.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-2`;

            const safeText = plaintext.replace(/[<>]/g, m => m === '<' ? '&lt;' : '&gt;');
            const timestamp = new Date(msg.timestamp || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            msgEl.innerHTML = `
                <div class="flex items-end gap-2 max-w-xs md:max-w-md">
                    <div class="message-bubble ${isMe ? 'sent' : 'received'}">
                        <p style="word-break: break-word;">${safeText}</p>
                    </div>
                    <span class="message-time">${timestamp}</span>
                </div>
            `;

            chatMessages.appendChild(msgEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // THIS WAS MISSING - ADD THIS FUNCTION
        async function handleSendMessage(e) {
            e.preventDefault();
            const text = messageInput.value.trim();

            if (!text || !app.currentChat) return;

            sendButton.disabled = true;

            try {
                const sharedKey = app.sharedKeys[app.currentChat.partner];
                const encrypted = await encryptMessage(sharedKey, text);

                gun.get('chats').get(app.currentChat.id).set({
                    sender: app.currentUser,
                    ct: encrypted.ct,
                    iv: encrypted.iv,
                    timestamp: Date.now(),
                    text: text
                });

                messageInput.value = '';
                sendButton.disabled = false;
                messageInput.focus();

            } catch (err) {
                console.error('Send error:', err);
                alert('Failed to send message.');
                sendButton.disabled = false;
            }
        }

        // Theme
        function applyTheme(theme) {
            const isLight = theme === 'light';
            document.documentElement.classList.toggle('light', isLight);
            if (themeIcon) {
                themeIcon.innerHTML = isLight
                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-11.34l-.7.7M4.04 19.96l-.7-.7M21 12h-1M4 12H3m15.66 5.66l-.7-.7M4.04 4.04l-.7.7M12 7a5 5 0 100 10 5 5 0 000-10z"></path>'
                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>';
            }
            localStorage.setItem('theme', theme);
        }

        async function initApp() {
            populateEmojis();

            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);

            themeToggle?.addEventListener('click', () => {
                const isDark = !document.documentElement.classList.contains('light');
                applyTheme(isDark ? 'light' : 'dark');
            });

            const username = sessionStorage.getItem('currentUser');
            const privKeyStr = sessionStorage.getItem('privKey');
            const pubKeyStr = sessionStorage.getItem('pubKey');

            if (username && privKeyStr && pubKeyStr) {
                try {
                    app.currentUser = username;
                    app.userKeys = {
                        privateKey: await importPrivKey(privKeyStr),
                        publicKey: await importPubKey(pubKeyStr)
                    };
                    await initChatPage();
                } catch (e) {
                    console.error('Session restore failed:', e);
                    handleLogout();
                }
            }

            tabLogin.addEventListener('click', () => switchTab('login'));
            tabSignup.addEventListener('click', () => switchTab('signup'));
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);

            logoutButton.addEventListener('click', handleLogout);
            newChatButton.addEventListener('click', () => {
                newChatModal.classList.remove('hidden');
                document.getElementById('new-chat-username').focus();
            });
            cancelNewChat.addEventListener('click', () => {
                newChatModal.classList.add('hidden');
                newChatForm.reset();
                newChatStatus.textContent = '';
            });
            newChatForm.addEventListener('submit', handleNewChat);
            messageForm.addEventListener('submit', handleSendMessage);
        }

        initApp();
    </script>
</body>
</html>