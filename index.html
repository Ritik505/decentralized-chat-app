===========decentralized chat=================









<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-Chat | Decentralized Chat</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Gun.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <!-- CryptoJS AES CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    
    <style>
/* --- Color Palette Definitions --- */
:root {
    --color-bg-primary: #0D1117;
    --color-bg-secondary: #161B22;
    --color-bg-card: #21262D;
    --color-border: #30363D;
    --color-accent-primary: #58A6FF;
    --color-accent-dark: #377FEA;
    --color-text-light: #C9D1D9;
    --color-text-muted: #8B949E;
}

.light {
    --color-bg-primary: #F6F8FA;
    --color-bg-secondary: #FFFFFF;
    --color-bg-card: #FFFFFF;
    --color-border: #E6E8EB;
    --color-accent-primary: #2563EB;
    --color-accent-dark: #1D4ED8;
    --color-text-light: #0F172A;
    --color-text-muted: #475569;
}

html, body {
    height: 100%;
    margin: 0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: var(--color-bg-primary) !important;
    color: var(--color-text-light) !important;
    box-sizing: border-box;
    overflow: hidden;
}

*, *::before, *::after { box-sizing: inherit; }

#auth-page { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; }

#auth-page > div {
    background-color: var(--color-bg-card) !important;
    border-radius: 12px !important;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    border: 1px solid var(--color-border);
}

#auth-page h1 { color: #FFFFFF !important; font-size: 1.875rem !important; }

.flex.border-b { border-bottom: 2px solid var(--color-border) !important; }
.flex.border-b button { 
    color: var(--color-text-muted) !important; 
    border-bottom: 2px solid transparent !important; 
    transition: all 0.2s ease;
}

#tab-login.active { 
    color: var(--color-text-light) !important;
    border-bottom-color: var(--color-accent-primary) !important;
}

#tab-signup.active {
    color: var(--color-text-light) !important;
    border-bottom-color: var(--color-accent-primary) !important;
}

#auth-forms input, #new-chat-username, #message-input {
    background-color: var(--color-bg-secondary) !important;
    border: 1px solid var(--color-border) !important;
    color: var(--color-text-light) !important;
    transition: border-color 0.2s, box-shadow 0.2s;
}

#auth-forms input:focus, #new-chat-username:focus, #message-input:focus {
    border-color: var(--color-accent-primary) !important;
    box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.3) !important;
    outline: none !important;
}

button[type="submit"], #new-chat-button {
    background-color: var(--color-accent-primary) !important;
    color: #FFFFFF !important;
    transition: background-color 0.2s;
}

button[type="submit"]:hover, #new-chat-button:hover {
    background-color: var(--color-accent-dark) !important;
}

button[type="submit"]:disabled, #new-chat-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#cancel-new-chat { 
    background-color: var(--color-bg-card) !important;
    color: var(--color-text-light) !important;
    border: 1px solid var(--color-border) !important;
}

#cancel-new-chat:hover {
    background-color: var(--color-border) !important;
}

#chat-page > div.flex { display: flex; height: 100%; }

.flex-col.w-full {
    background-color: var(--color-bg-secondary) !important;
    border-right: 1px solid var(--color-border) !important;
}

.flex-shrink-0.h-16 {
    background-color: var(--color-bg-secondary) !important;
    border-bottom: 1px solid var(--color-border) !important;
}

#user-avatar, #chat-partner-avatar {
    background-color: var(--color-accent-dark) !important;
    width: 36px !important; 
    height: 36px !important;
}

#logout-button { color: var(--color-text-muted) !important; }
#logout-button:hover { color: var(--color-text-light) !important; }

#contacts-list { overflow-y: auto; }

.contact-item { 
    display: flex; align-items: center; padding: 1rem; cursor: pointer; 
    border-bottom: 1px solid var(--color-border); 
    transition: background-color 0.15s ease;
}

.contact-item:hover { background-color: var(--color-bg-card) !important; }

.contact-item.active {
    background-color: var(--color-bg-card) !important;
    border-left: 3px solid var(--color-accent-primary);
    margin-left: -3px;
}

.contact-item p { color: var(--color-text-light) !important; }
.contact-item p.text-sm { color: var(--color-text-muted) !important; }

.flex-1.flex.flex-col { background-color: var(--color-bg-primary) !important; }

#chat-welcome { color: var(--color-text-muted) !important; }
#chat-welcome h2 { color: var(--color-text-light) !important; }

#message-form {
    background-color: var(--color-bg-secondary) !important;
    border-top: 1px solid var(--color-border) !important;
}

#chat-messages { overflow-y: auto; }

.message-row { 
    display: flex; margin-bottom: 0.5rem; 
    align-items: flex-end;
}

.message-bubble { 
    max-width: 65%;
    padding: 0.75rem 1rem; 
    border-radius: 18px; 
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.15); 
    word-wrap: break-word;
    line-height: 1.4;
}

.message-bubble.sent {
    background-color: var(--color-accent-primary) !important;
    color: #FFFFFF !important;
    margin-left: auto;
    border-bottom-right-radius: 8px;
}

.message-bubble.received {
    background-color: var(--color-bg-card) !important;
    color: var(--color-text-light) !important;
    margin-right: auto;
    border-bottom-left-radius: 8px;
}

.message-time { 
    color: rgba(201, 209, 217, 0.5);
    font-size: 0.7rem; 
    margin: 0 8px;
    align-self: flex-end;
}

#chat-messages::-webkit-scrollbar,
#contacts-list::-webkit-scrollbar { width: 8px; height: 8px; }

#chat-messages::-webkit-scrollbar-track,
#contacts-list::-webkit-scrollbar-track { background: var(--color-bg-secondary); }

#chat-messages::-webkit-scrollbar-thumb,
#contacts-list::-webkit-scrollbar-thumb { 
    background: var(--color-border);
    border-radius: 4px; 
}

#chat-messages::-webkit-scrollbar-thumb:hover,
#contacts-list::-webkit-scrollbar-thumb:hover { background: var(--color-text-muted); }

.hidden { display: none !important; }

.emoji-button {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 20px;
    width: 40px;
    height: 40px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-light);
}

#emoji-picker {
    position: absolute;
    bottom: 72px;
    right: 24px;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    padding: 8px;
    border-radius: 8px;
    display: none;
    width: 260px;
    max-width: calc(100% - 48px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    z-index: 60;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 6px;
    max-height: 220px;
    overflow: auto;
}

.emoji-cell {
    font-size: 1.25rem;
    padding: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    background: none;
    border: none;
}

.emoji-cell:hover {
    background: var(--color-bg-secondary);
}

.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.status-message {
    padding: 12px;
    border-radius: 8px;
    margin: 8px 0;
    font-size: 14px;
}

.status-error {
    background-color: rgba(239, 68, 68, 0.2) !important;
    color: #FCA5A5 !important;
    border: 1px solid rgba(239, 68, 68, 0.5);
}

.status-success {
    background-color: rgba(34, 197, 94, 0.2) !important;
    color: #86EFAC !important;
    border: 1px solid rgba(34, 197, 94, 0.5);
}

.status-info {
    background-color: rgba(59, 130, 246, 0.2) !important;
    color: #93C5FD !important;
    border: 1px solid rgba(59, 130, 246, 0.5);
}

@media (max-width: 768px) {
    .flex-col.w-full { width: 100% !important; }
    .message-bubble { max-width: 85%; }
}
    </style>
</head>
<body class="h-full font-sans text-gray-200 antialiased">

    <!-- Main Application Container -->
    <div id="app-container" class="h-full">

        <!-- ===== Auth Page ===== -->
        <div id="auth-page" class="flex items-center justify-center h-full p-4">
            <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-lg p-8">
                <h1 class="text-3xl font-bold text-center text-white mb-2">D-Chat</h1>
                <p class="text-center text-gray-400 mb-6">Decentralized & Encrypted</p>

                <!-- Tabs -->
                <div class="flex border-b border-gray-700 mb-6">
                    <button id="tab-login" class="flex-1 py-2 font-semibold active transition-colors duration-200">
                        Login
                    </button>
                    <button id="tab-signup" class="flex-1 py-2 font-semibold transition-colors duration-200">
                        Sign Up
                    </button>
                </div>

                <!-- Auth Forms -->
                <div id="auth-forms">
                    <!-- Login Form -->
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-username" class="block text-sm font-medium text-gray-300">Username</label>
                            <input type="text" id="login-username" required autocomplete="username" class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="login-password" required autocomplete="current-password" class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button type="submit" id="login-submit" class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-semibold transition duration-200">
                            Login
                        </button>
                    </form>

                    <!-- Signup Form -->
                    <form id="signup-form" class="space-y-4 hidden">
                        <div>
                            <label for="signup-username" class="block text-sm font-medium text-gray-300">Username</label>
                            <input type="text" id="signup-username" required autocomplete="username" minlength="3" maxlength="32" class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-400 mt-1">3-32 characters, alphanumeric and underscore only</p>
                        </div>
                        <div>
                            <label for="signup-password" class="block text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="signup-password" required autocomplete="new-password" minlength="8" class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-400 mt-1">Minimum 8 characters</p>
                        </div>
                        <button type="submit" id="signup-submit" class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-semibold transition duration-200">
                            Sign Up
                        </button>
                    </form>
                </div>

                <div id="auth-status" class="mt-4"></div>
            </div>
        </div>

        <!-- ===== Chat Page ===== -->
        <div id="chat-page" class="hidden h-full">
            <div class="flex h-full">
                <!-- Sidebar (Contacts List) -->
                <div class="flex flex-col w-full md:w-1/3 lg:w-1/4 h-full bg-gray-800 border-r border-gray-700">
                    <!-- Sidebar Header -->
                    <div class="flex items-center justify-between p-4 border-b border-gray-700 h-16 flex-shrink-0">
                        <div class="flex items-center space-x-2 min-w-0">
                            <div id="user-avatar" class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white flex-shrink-0"></div>
                            <span id="current-username" class="font-semibold text-white truncate"></span>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <button id="theme-toggle" class="text-gray-400 hover:text-white p-2" title="Toggle theme" aria-label="Toggle theme">
                                <svg id="theme-icon" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-11.34l-.7.7M4.04 19.96l-.7-.7M21 12h-1M4 12H3m15.66 5.66l-.7-.7M4.04 4.04l-.7.7"></path>
                                </svg>
                            </button>
                            <button id="logout-button" class="text-gray-400 hover:text-white p-2" title="Logout" aria-label="Logout">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            </button>
                        </div>
                    </div>

                    <!-- New Chat Button -->
                    <div class="p-4">
                        <button id="new-chat-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span>New Chat</span>
                        </button>
                    </div>

                    <!-- Contacts List -->
                    <div id="contacts-list" class="flex-1 overflow-y-auto">
                        <p id="no-contacts" class="text-gray-500 text-center p-4">No recent chats.</p>
                    </div>
                </div>

                <!-- Main Chat Area -->
                <div class="flex-1 flex flex-col h-full">
                    <!-- Chat Header -->
                    <div id="chat-header" class="flex items-center p-4 border-b border-gray-700 h-16 flex-shrink-0 bg-gray-800 hidden">
                        <div id="chat-partner-avatar" class="w-8 h-8 rounded-full bg-gray-500 flex items-center justify-center font-bold text-white flex-shrink-0"></div>
                        <span id="chat-partner-username" class="ml-3 font-semibold text-white truncate"></span>
                    </div>

                    <!-- Welcome/Empty State -->
                    <div id="chat-welcome" class="flex-1 flex flex-col items-center justify-center text-gray-500 p-8 text-center">
                        <svg class="w-24 h-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 5.523-4.477 10-10 10S1 17.523 1 12 5.477 2 11 2s10 4.477 10 10z"></path></svg>
                        <h2 class="text-2xl font-semibold text-gray-400">Welcome to D-Chat</h2>
                        <p>Select a chat on the left or start a new one.</p>
                        <p class="text-sm mt-2">All messages are end-to-end encrypted.</p>
                    </div>
                    
                    <!-- Messages Container -->
                    <div id="chat-messages-container" class="hidden flex-1 flex flex-col">
                        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                            <!-- Messages will be injected here -->
                        </div>

                        <!-- Message Input -->
                        <form id="message-form" class="p-4 border-t border-gray-700 bg-gray-800 relative">
                            <div class="flex items-center space-x-3">
                                <button type="button" id="emoji-button" class="emoji-button" title="Insert emoji">ðŸ˜Š</button>
                                <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <button type="submit" id="send-button" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg p-3 transition duration-200">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                            </div>
                            <!-- Emoji picker -->
                            <div id="emoji-picker" aria-hidden="true">
                                <div class="emoji-grid" id="emoji-grid"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Chat Modal -->
        <div id="new-chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-md">
                <h2 class="text-2xl font-bold text-white mb-6">Start a New Chat</h2>
                <form id="new-chat-form">
                    <div class="space-y-4">
                        <div>
                            <label for="new-chat-username" class="block text-sm font-medium text-gray-300">Username</label>
                            <input type="text" id="new-chat-username" required autocomplete="off" class="mt-1 block w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <p id="new-chat-status" class="text-sm"></p>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="cancel-new-chat" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-semibold transition duration-200">
                                Cancel
                            </button>
                            <button type="submit" id="new-chat-submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-semibold transition duration-200">
                                Start Chat
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- JavaScript -->
    <script type="module">
        // ===================================
        // ---       GLOBALS & CONFIG       ---
        // ===================================
        
        // Initialize Gun with multiple reliable public peers
        const gun = (typeof window !== 'undefined' && window.Gun) 
            ? Gun({
                peers: [
                    'https://gun.db20.com/gun',           // Reliable public peer
                    'https://gunjs.herokuapp.com/gun',     // Alternative peer
                    'https://gun-server-gun.herokuapp.com/gun', // Backup peer
                    'https://api.gundb.io/gun'             // Official peer
                ]
            }) 
            : null;

        if (!gun) {
            alert('Gun.js failed to load. Please check your internet connection.');
            throw new Error('Gun.js initialization failed');
        }

        const app = {
            currentUser: null,
            currentChat: null,
            sharedKeys: {},
            userKeys: null,
            listeners: {},
            messageCache: {},
            isOnline: navigator.onLine,
            gunConnected: false
        };

        // Monitor connection status
        window.addEventListener('online', () => { app.isOnline = true; });
        window.addEventListener('offline', () => { app.isOnline = false; });

        // Monitor Gun connection
        gun.on('create', () => {
            console.log('Gun.js connected');
            app.gunConnected = true;
            updateGunStatus();
        });

        gun.on('out', () => {
            console.log('Gun.js sending data');
            app.gunConnected = true;
            updateGunStatus();
        });

        function updateGunStatus() {
            const indicator = document.getElementById('gun-status');
            if (indicator) {
                indicator.classList.remove('offline');
                indicator.querySelector('span').textContent = 'Connected to Gun';
            }
        }

        // ===================================
        // ---       DOM ELEMENTS          ---
        // ===================================
        
        const authPage = document.getElementById('auth-page');
        const chatPage = document.getElementById('chat-page');
        const authStatus = document.getElementById('auth-status');
        const tabLogin = document.getElementById('tab-login');
        const tabSignup = document.getElementById('tab-signup');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginSubmit = document.getElementById('login-submit');
        const signupSubmit = document.getElementById('signup-submit');
        const currentUsernameEl = document.getElementById('current-username');
        const userAvatarEl = document.getElementById('user-avatar');
        const logoutButton = document.getElementById('logout-button');
        const newChatButton = document.getElementById('new-chat-button');
        const newChatModal = document.getElementById('new-chat-modal');
        const newChatForm = document.getElementById('new-chat-form');
        const newChatStatus = document.getElementById('new-chat-status');
        const newChatSubmit = document.getElementById('new-chat-submit');
        const cancelNewChat = document.getElementById('cancel-new-chat');
        const contactsList = document.getElementById('contacts-list');
        const noContactsEl = document.getElementById('no-contacts');
        const chatWelcome = document.getElementById('chat-welcome');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const chatHeader = document.getElementById('chat-header');
        const chatPartnerAvatar = document.getElementById('chat-partner-avatar');
        const chatPartnerUsername = document.getElementById('chat-partner-username');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPicker = document.getElementById('emoji-picker');
        const emojiGrid = document.getElementById('emoji-grid');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        const EMOJIS = ['ðŸ˜€','ðŸ˜','ðŸ˜‚','ðŸ¤£','ðŸ™‚','ðŸ™ƒ','ðŸ˜‰','ðŸ˜','ðŸ˜˜','ðŸ˜…','ðŸ¤”','ðŸ¤ž','ðŸ‘','ðŸ‘Ž','ðŸ™','ðŸŽ‰','ðŸ”¥','ðŸŒŸ','ðŸ’¯','â¤ï¸','ðŸ˜Ž','ðŸ¤—','ðŸ˜´','ðŸ¤–','ðŸ˜‡','ðŸ˜¬','ðŸ˜œ','ðŸ˜¢','ðŸ˜­','ðŸ˜¡','ðŸ¥³'];

        // ===================================
        // ---    UTILITY FUNCTIONS        ---
        // ===================================

        function showStatus(message, type = 'info') {
            const statusEl = authStatus;
            statusEl.innerHTML = '';
            
            if (!message) {
                statusEl.textContent = '';
                return;
            }

            const div = document.createElement('div');
            div.className = `status-message status-${type}`;
            div.textContent = message;
            statusEl.appendChild(div);
        }

        function validateUsername(username) {
            return /^[a-zA-Z0-9_]{3,32}$/.test(username);
        }

        function validatePassword(password) {
            return password.length >= 8;
        }

        function populateEmojis() {
            if (!emojiGrid) return;
            emojiGrid.innerHTML = '';
            EMOJIS.forEach(e => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'emoji-cell';
                btn.textContent = e;
                btn.addEventListener('click', (evt) => {
                    evt.preventDefault();
                    insertAtCaret(messageInput, e);
                    hideEmojiPicker();
                    messageInput.focus();
                });
                emojiGrid.appendChild(btn);
            });
        }

        function insertAtCaret(input, text) {
            const start = input.selectionStart || 0;
            const end = input.selectionEnd || 0;
            const value = input.value || '';
            input.value = value.slice(0, start) + text + value.slice(end);
            const pos = start + text.length;
            input.setSelectionRange(pos, pos);
        }

        function toggleEmojiPicker() {
            if (!emojiPicker) return;
            emojiPicker.style.display === 'block' ? hideEmojiPicker() : showEmojiPicker();
        }

        function showEmojiPicker() {
            if (!emojiPicker) return;
            populateEmojis();
            emojiPicker.style.display = 'block';
            emojiPicker.setAttribute('aria-hidden', 'false');
        }

        function hideEmojiPicker() {
            if (!emojiPicker) return;
            emojiPicker.style.display = 'none';
            emojiPicker.setAttribute('aria-hidden', 'true');
        }

        document.addEventListener('click', (e) => {
            if (!emojiPicker || !emojiButton) return;
            if (!emojiPicker.contains(e.target) && !emojiButton.contains(e.target)) {
                hideEmojiPicker();
            }
        });

        emojiButton?.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleEmojiPicker();
        });

        // ===================================
        // ---      CRYPTO UTILITIES       ---
        // ===================================
        
        function arrayBufferToB64(buffer) {
            const bytes = buffer instanceof Uint8Array ? buffer : new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function b64ToArrayBuffer(b64) {
            const binary = window.atob(b64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function textToArrayBuffer(str) {
            return new TextEncoder().encode(str);
        }

        function arrayBufferToText(buffer) {
            return new TextDecoder().decode(buffer);
        }

        async function generateKeys() {
            return await crypto.subtle.generateKey(
                { name: 'ECDH', namedCurve: 'P-256' },
                true,
                ['deriveKey']
            );
        }

        async function importPubKey(jwk) {
            if (typeof jwk === 'string') jwk = JSON.parse(jwk);
            return await crypto.subtle.importKey(
                'jwk',
                jwk,
                { name: 'ECDH', namedCurve: 'P-256' },
                true,
                []
            );
        }

        async function importPrivKey(jwk) {
            if (typeof jwk === 'string') jwk = JSON.parse(jwk);
            return await crypto.subtle.importKey(
                'jwk',
                jwk,
                { name: 'ECDH', namedCurve: 'P-256' },
                true,
                ['deriveKey']
            );
        }

        async function deriveSharedKey(myPrivateKey, partnerPublicKey) {
            return await crypto.subtle.deriveKey(
                { name: 'ECDH', public: partnerPublicKey },
                myPrivateKey,
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        }

        async function encryptMessage(sharedKey, plaintext) {
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encodedText = textToArrayBuffer(plaintext);
            const ciphertext = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                sharedKey,
                encodedText
            );
            return {
                ct: arrayBufferToB64(ciphertext),
                iv: arrayBufferToB64(iv)
            };
        }

        async function decryptMessage(sharedKey, ct_b64, iv_b64) {
            try {
                const ciphertext = b64ToArrayBuffer(ct_b64);
                const iv = new Uint8Array(b64ToArrayBuffer(iv_b64));
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    sharedKey,
                    ciphertext
                );
                return arrayBufferToText(decrypted);
            } catch (e) {
                console.error("Decryption error:", e);
                return "ðŸ”’ Unable to decrypt";
            }
        }

        // ===================================
        // ---       AUTH LOGIC            ---
        // ===================================

        function switchTab(tab) {
            const isLogin = tab === 'login';
            loginForm.classList.toggle('hidden', !isLogin);
            signupForm.classList.toggle('hidden', isLogin);
            
            tabLogin.classList.toggle('active', isLogin);
            tabSignup.classList.toggle('active', !isLogin);
            
            showStatus('');
        }

        async function handleSignup(e) {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim().toLowerCase();
            const password = document.getElementById('signup-password').value;

            if (!validateUsername(username)) {
                showStatus('Username must be 3-32 characters, alphanumeric + underscore only.', 'error');
                return;
            }
            if (!validatePassword(password)) {
                showStatus('Password must be at least 8 characters.', 'error');
                return;
            }

            signupSubmit.disabled = true;
            showStatus('Checking username...', 'info');

            try {
                // Check if username exists
                const userExists = await fetchUserData(username);

                if (userExists && userExists.pubKey) {
                    showStatus('Username already taken.', 'error');
                    signupSubmit.disabled = false;
                    return;
                }

                showStatus('Generating encryption keys...', 'info');
                const keyPair = await generateKeys();
                const pubKeyJwk = await crypto.subtle.exportKey('jwk', keyPair.publicKey);
                const privKeyJwk = await crypto.subtle.exportKey('jwk', keyPair.privateKey);

                const encryptedPrivKey = CryptoJS.AES.encrypt(
                    JSON.stringify(privKeyJwk),
                    password
                ).toString();

                showStatus('Creating account...', 'info');
                
                // Create user with all fields
                const userNode = gun.get('users').get(username);
                userNode.put({
                    pubKey: JSON.stringify(pubKeyJwk),
                    privKey: encryptedPrivKey,
                    createdAt: Date.now(),
                    version: 1
                });

                // Create empty chats object
                userNode.get('chats').put({});

                // Wait for data to propagate
                await new Promise(resolve => setTimeout(resolve, 2000));

                showStatus('âœ… Signup successful! Redirecting...', 'success');
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                signupForm.reset();
                document.getElementById('login-username').value = username;
                switchTab('login');
                document.getElementById('login-password').focus();
                signupSubmit.disabled = false;
                showStatus('');

            } catch (err) {
                console.error('Signup error:', err);
                showStatus('Signup failed: ' + err.message, 'error');
                signupSubmit.disabled = false;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                showStatus('Username and password required.', 'error');
                return;
            }

            loginSubmit.disabled = true;
            showStatus('Logging in...', 'info');

            const timeout = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Login timeout')), 10000)
            );

            try {
                const userData = await Promise.race([
                    new Promise(resolve => {
                        gun.get('users').get(username).once(resolve);
                    }),
                    timeout
                ]);

                if (!userData || !userData.privKey) {
                    showStatus('Invalid username or password.', 'error');
                    loginSubmit.disabled = false;
                    return;
                }

                const decryptedStr = CryptoJS.AES.decrypt(userData.privKey, password)
                    .toString(CryptoJS.enc.Utf8);
                
                if (!decryptedStr) {
                    showStatus('Invalid username or password.', 'error');
                    loginSubmit.disabled = false;
                    return;
                }

                const privKeyJwk = JSON.parse(decryptedStr);
                const pubKeyJwk = typeof userData.pubKey === 'string' 
                    ? JSON.parse(userData.pubKey) 
                    : userData.pubKey;

                showStatus('Importing keys...', 'info');
                app.userKeys = {
                    privateKey: await importPrivKey(privKeyJwk),
                    publicKey: await importPubKey(pubKeyJwk)
                };

                app.currentUser = username;
                sessionStorage.setItem('currentUser', username);
                sessionStorage.setItem('privKey', JSON.stringify(privKeyJwk));
                sessionStorage.setItem('pubKey', JSON.stringify(pubKeyJwk));

                loginForm.reset();
                showStatus('');
                await initChatPage();
                loginSubmit.disabled = false;

            } catch (err) {
                console.error('Login error:', err);
                showStatus(err.message || 'Login failed.', 'error');
                loginSubmit.disabled = false;
            }
        }

        function handleLogout() {
            // Detach all listeners
            Object.values(app.listeners).forEach(off => {
                try { if (typeof off === 'function') off(); } catch (e) {}
            });
            app.listeners = {};

            sessionStorage.clear();
            app.currentUser = null;
            app.userKeys = null;
            app.currentChat = null;
            app.sharedKeys = {};
            app.messageCache = {};

            contactsList.innerHTML = '';
            chatMessages.innerHTML = '';
            noContactsEl.classList.remove('hidden');

            chatPage.classList.add('hidden');
            authPage.classList.remove('hidden');
            switchTab('login');
        }

        // ===================================
        // ---       CHAT LOGIC            ---
        // ===================================

        async function initChatPage() {
            authPage.classList.add('hidden');
            chatPage.classList.remove('hidden');
            currentUsernameEl.textContent = app.currentUser;
            userAvatarEl.textContent = app.currentUser.charAt(0).toUpperCase();
            loadUserChats();
        }

        function loadUserChats() {
            if (app.listeners.chatsLoader) app.listeners.chatsLoader();

            contactsList.innerHTML = '';
            noContactsEl.classList.remove('hidden');

            const chatsRef = gun.get('users').get(app.currentUser).get('chats');
            
            const offFunc = chatsRef.map().on((val, key) => {
                if (!val || key === '_') return;
                const partner = key;
                if (partner !== app.currentUser) {
                    addContactToList(partner, key);
                }
            });

            app.listeners.chatsLoader = offFunc;
        }

        // FIXED: Improved user search with multiple retry attempts
        async function handleNewChat(e) {
            e.preventDefault();
            const username = document.getElementById('new-chat-username').value.trim().toLowerCase();
            newChatStatus.textContent = '';

            if (!username) {
                newChatStatus.textContent = 'Enter a username.';
                newChatStatus.className = 'text-sm status-error';
                return;
            }

            if (username === app.currentUser) {
                newChatStatus.textContent = "Can't chat with yourself.";
                newChatStatus.className = 'text-sm status-error';
                return;
            }

            newChatSubmit.disabled = true;
            newChatStatus.textContent = 'Searching user...';
            newChatStatus.className = 'text-sm status-info';

            try {
                // Search with aggressive retries for public peers
                let userData = null;
                for (let attempt = 1; attempt <= 4; attempt++) {
                    newChatStatus.textContent = `Searching (${attempt}/4)...`;
                    
                    userData = await fetchUserData(username);
                    
                    if (userData && userData.pubKey) {
                        break;
                    }
                    
                    // Wait before retry
                    if (attempt < 4) {
                        await new Promise(resolve => setTimeout(resolve, 800));
                    }
                }

                if (!userData || !userData.pubKey) {
                    newChatStatus.textContent = 'User not found. Verify username and try again.';
                    newChatStatus.className = 'text-sm status-error';
                    newChatSubmit.disabled = false;
                    return;
                }

                newChatStatus.textContent = 'Creating chat...';
                
                // Create chat references
                gun.get('users').get(app.currentUser).get('chats').get(username).put({ createdAt: Date.now() });
                gun.get('users').get(username).get('chats').get(app.currentUser).put({ createdAt: Date.now() });

                // Wait for sync
                await new Promise(resolve => setTimeout(resolve, 1200));

                addContactToList(username);
                newChatModal.classList.add('hidden');
                newChatForm.reset();
                newChatStatus.textContent = '';
                newChatSubmit.disabled = false;

                openChat(username);

            } catch (err) {
                console.error('New chat error:', err);
                newChatStatus.textContent = 'Error: ' + (err.message || 'Search failed');
                newChatStatus.className = 'text-sm status-error';
                newChatSubmit.disabled = false;
            }
        }

        // Fetch user data with proper Gun syntax for public peers
        function fetchUserData(username) {
            return new Promise((resolve) => {
                let found = false;
                let timeoutId;
                
                const cleanup = () => {
                    clearTimeout(timeoutId);
                    found = true;
                };

                timeoutId = setTimeout(() => {
                    if (!found) {
                        found = true;
                        resolve(null);
                    }
                }, 4000);

                // Strategy 1: Try to fetch complete user object
                gun.get('users').get(username).once((userData, key) => {
                    if (found) return;
                    
                    if (userData && userData.pubKey) {
                        cleanup();
                        resolve({ pubKey: userData.pubKey });
                        return;
                    }

                    // Strategy 2: If not found, try direct pubKey
                    if (!userData) {
                        gun.get('users').get(username).get('pubKey').once((pubKey) => {
                            if (found) return;
                            
                            if (pubKey && typeof pubKey === 'string' && pubKey.length > 20) {
                                cleanup();
                                resolve({ pubKey: pubKey });
                            }
                        });
                    }
                }, { wait: 500 });
            });
        }

        function addContactToList(username) {
            noContactsEl.classList.add('hidden');
            
            const existing = document.getElementById(`contact-${username}`);
            if (existing) return;

            const contactEl = document.createElement('div');
            contactEl.id = `contact-${username}`;
            contactEl.className = 'contact-item';
            contactEl.innerHTML = `
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white flex-shrink-0" style="background-color: hsl(${username.charCodeAt(0) * 10}, 70%, 50%)">
                    ${username.charAt(0).toUpperCase()}
                </div>
                <div class="ml-3 flex-1 min-w-0">
                    <p class="font-semibold truncate">${username}</p>
                    <p class="text-sm truncate">Tap to open</p>
                </div>
            `;

            contactEl.addEventListener('click', () => openChat(username));
            contactsList.prepend(contactEl);
        }

        // ===================================
        // ---    THEME & INITIALIZATION   ---
        // ===================================

        function applyTheme(theme) {
            const isLight = theme === 'light';
            document.documentElement.classList.toggle('light', isLight);
            if (themeIcon) {
                themeIcon.innerHTML = isLight
                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-11.34l-.7.7M4.04 19.96l-.7-.7M21 12h-1M4 12H3m15.66 5.66l-.7-.7M4.04 4.04l-.7.7M12 7a5 5 0 100 10 5 5 0 000-10z"></path>'
                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>';
            }
            localStorage.setItem('theme', theme);
        }

        async function initApp() {
            populateEmojis();

            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);

            themeToggle?.addEventListener('click', () => {
                const isDark = !document.documentElement.classList.contains('light');
                applyTheme(isDark ? 'light' : 'dark');
            });

            // Session restore
            const username = sessionStorage.getItem('currentUser');
            const privKeyStr = sessionStorage.getItem('privKey');
            const pubKeyStr = sessionStorage.getItem('pubKey');

            if (username && privKeyStr && pubKeyStr) {
                try {
                    app.currentUser = username;
                    app.userKeys = {
                        privateKey: await importPrivKey(privKeyStr),
                        publicKey: await importPubKey(pubKeyStr)
                    };
                    await initChatPage();
                } catch (e) {
                    console.error('Session restore failed:', e);
                    handleLogout();
                }
            }

            // Event listeners
            tabLogin.addEventListener('click', () => switchTab('login'));
            tabSignup.addEventListener('click', () => switchTab('signup'));
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);

            logoutButton.addEventListener('click', handleLogout);
            newChatButton.addEventListener('click', () => {
                newChatModal.classList.remove('hidden');
                document.getElementById('new-chat-username').focus();
            });
            cancelNewChat.addEventListener('click', () => {
                newChatModal.classList.add('hidden');
                newChatForm.reset();
                newChatStatus.textContent = '';
            });
            newChatForm.addEventListener('submit', handleNewChat);
            messageForm.addEventListener('submit', handleSendMessage);
        }

        initApp().catch(e => {
            console.error('App init failed:', e);
            showStatus('Failed to initialize app.', 'error');
        });
    </script>
</body>
</html>